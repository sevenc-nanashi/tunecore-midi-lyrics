// ==UserScript==
// @name         tunecore-midi-lyrics
// @version      0.1.0
// @author       Nanashi. <https://sevenc7c.com>
// @description  Tunecoreの歌詞登録をMIDIからできるようにするUserscript
// @homepage     https://github.com/sevenc-nanashi/tunecore-midi-lyrics#readme
// @homepageURL  https://github.com/sevenc-nanashi/tunecore-midi-lyrics#readme
// @match        https://www.tunecore.co.jp/member/release/*
// ==/UserScript==

(function () {
    'use strict';

    let L=Object.getPrototypeOf,re,Te,W,te,nt={isConnected:1},It=1e3,se,wt={},xt=L(nt),it=L(L),z,ot=(e,r,i,n)=>(e??(n?setTimeout(i,n):queueMicrotask(i),new Set)).add(r),st=(e,r,i)=>{let n=W;W=r;try{return e(i)}catch(o){return console.error(o),i}finally{W=n;}},fe=e=>e.filter(r=>r._dom?.isConnected),at=e=>se=ot(se,e,()=>{for(let r of se)r._bindings=fe(r._bindings),r._listeners=fe(r._listeners);se=z;},It),he={get val(){return W?._getters?.add(this),this.rawVal},get oldVal(){return W?._getters?.add(this),this._oldVal},set val(e){W?._setters?.add(this),e!==this.rawVal&&(this.rawVal=e,this._bindings.length+this._listeners.length?(Te?.add(this),re=ot(re,this,Tt)):this._oldVal=e);}},ct=e=>({__proto__:he,rawVal:e,_oldVal:e,_bindings:[],_listeners:[]}),ne=(e,r)=>{let i={_getters:new Set,_setters:new Set},n={f:e},o=te;te=[];let t=st(e,i,r);t=(t??document).nodeType?t:new Text(t);for(let s of i._getters)i._setters.has(s)||(at(s),s._bindings.push(n));for(let s of te)s._dom=t;return te=o,n._dom=t},Oe=(e,r=ct(),i)=>{let n={_getters:new Set,_setters:new Set},o={f:e,s:r};o._dom=i??te?.push(o)??nt,r.val=st(e,n,r.rawVal);for(let t of n._getters)n._setters.has(t)||(at(t),t._listeners.push(o));return r},ut=(e,...r)=>{for(let i of r.flat(1/0)){let n=L(i??0),o=n===he?ne(()=>i.val):n===it?ne(i):i;o!=z&&e.append(o);}return e},lt=(e,r,...i)=>{let[{is:n,...o},...t]=L(i[0]??0)===xt?i:[{},...i],s=e?document.createElementNS(e,r,{is:n}):document.createElement(r,{is:n});for(let[c,u]of Object.entries(o)){let l=b=>b?Object.getOwnPropertyDescriptor(b,c)??l(L(b)):z,a=r+","+c,h=wt[a]??=l(L(s))?.set??0,f=c.startsWith("on")?(b,k)=>{let y=c.slice(2);s.removeEventListener(y,k),s.addEventListener(y,b);}:h?h.bind(s):s.setAttribute.bind(s,c),d=L(u??0);c.startsWith("on")||d===it&&(u=Oe(u),d=he),d===he?ne(()=>(f(u.val,u._oldVal),s)):f(u);}return ut(s,t)},je=e=>({get:(r,i)=>lt.bind(z,e,i)}),ft=(e,r)=>r?r!==e&&e.replaceWith(r):e.remove(),Tt=()=>{let e=0,r=[...re].filter(n=>n.rawVal!==n._oldVal);do{Te=new Set;for(let n of new Set(r.flatMap(o=>o._listeners=fe(o._listeners))))Oe(n.f,n.s,n._dom),n._dom=z;}while(++e<100&&(r=[...Te]).length);let i=[...re].filter(n=>n.rawVal!==n._oldVal);re=z;for(let n of new Set(i.flatMap(o=>o._bindings=fe(o._bindings))))ft(n._dom,ne(n.f,n._dom)),n._dom=z;for(let n of i)n._oldVal=n.rawVal;};const ht={tags:new Proxy(e=>new Proxy(lt,je(e)),je()),hydrate:(e,r)=>ft(e,ne(r,e)),add:ut,state:ct,derive:Oe},ue=e=>e.type==="Failure",Pe=e=>typeof e=="object"&&e!==null&&"then"in e&&typeof e.then=="function"&&"catch"in e&&typeof e.catch=="function",_e=(...e)=>{if(e.length<=0)return {type:"Success"};const r=e[0];return Pe(r)?r.then(i=>({type:"Success",value:i})):{type:"Success",value:r}},D=(...e)=>{if(e.length<=0)return {type:"Failure"};const r=e[0];return Pe(r)?r.then(i=>({type:"Failure",error:i})):{type:"Failure",error:r}},Ne=e=>{const r=(...i)=>{try{const n=e.try(...i);if(Pe(n)){const o=_e(n);return "safe"in e&&e.safe?o:o.catch(t=>D(e.catch(t)))}return _e(n)}catch(n){if("safe"in e&&e.safe)throw n;return D(e.catch(n))}};return "immediate"in e&&e.immediate?r():r},C=Symbol.for("@ts-pattern/matcher"),dt=Symbol.for("@ts-pattern/isVariadic"),de="@ts-pattern/anonymous-select-key",Se=e=>!!(e&&typeof e=="object"),le=e=>e&&!!e[C],T=(e,r,i)=>{if(le(e)){const n=e[C](),{matched:o,selections:t}=n.match(r);return o&&t&&Object.keys(t).forEach(s=>i(s,t[s])),o}if(Se(e)){if(!Se(r))return  false;if(Array.isArray(e)){if(!Array.isArray(r))return  false;let n=[],o=[],t=[];for(const s of e.keys()){const c=e[s];le(c)&&c[dt]?t.push(c):t.length?o.push(c):n.push(c);}if(t.length){if(t.length>1)throw new Error("Pattern error: Using `...P.array(...)` several times in a single pattern is not allowed.");if(r.length<n.length+o.length)return  false;const s=r.slice(0,n.length),c=o.length===0?[]:r.slice(-o.length),u=r.slice(n.length,o.length===0?1/0:-o.length);return n.every((l,a)=>T(l,s[a],i))&&o.every((l,a)=>T(l,c[a],i))&&(t.length===0||T(t[0],u,i))}return e.length===r.length&&e.every((s,c)=>T(s,r[c],i))}return Reflect.ownKeys(e).every(n=>{const o=e[n];return (n in r||le(t=o)&&t[C]().matcherType==="optional")&&T(o,r[n],i);var t;})}return Object.is(r,e)},M=e=>{var r,i,n;return Se(e)?le(e)?(r=(i=(n=e[C]()).getSelectionKeys)==null?void 0:i.call(n))!=null?r:[]:Array.isArray(e)?ie(e,M):ie(Object.values(e),M):[]},ie=(e,r)=>e.reduce((i,n)=>i.concat(r(n)),[]);function _t(...e){if(e.length===1){const[r]=e;return i=>T(r,i,()=>{})}if(e.length===2){const[r,i]=e;return T(r,i,()=>{})}throw new Error(`isMatching wasn't given the right number of arguments: expected 1 or 2, received ${e.length}.`)}function _(e){return Object.assign(e,{optional:()=>Be(e),and:r=>x(e,r),or:r=>pt(e,r),select:r=>r===void 0?oe(e):oe(r,e)})}function Ue(e){return Object.assign((r=>Object.assign(r,{[Symbol.iterator](){let i=0;const n=[{value:Object.assign(r,{[dt]:true}),done:false},{done:true,value:void 0}];return {next:()=>{var o;return (o=n[i++])!=null?o:n.at(-1)}}}}))(e),{optional:()=>Ue(Be(e)),select:r=>Ue(r===void 0?oe(e):oe(r,e))})}function Be(e){return _({[C]:()=>({match:r=>{let i={};const n=(o,t)=>{i[o]=t;};return r===void 0?(M(e).forEach(o=>n(o,void 0)),{matched:true,selections:i}):{matched:T(e,r,n),selections:i}},getSelectionKeys:()=>M(e),matcherType:"optional"})})}const St=(e,r)=>{for(const i of e)if(!r(i))return  false;return  true},Ut=(e,r)=>{for(const[i,n]of e.entries())if(!r(n,i))return  false;return  true},Mt=(e,r)=>{const i=Reflect.ownKeys(e);for(const n of i)if(!r(n,e[n]))return  false;return  true};function x(...e){return _({[C]:()=>({match:r=>{let i={};const n=(o,t)=>{i[o]=t;};return {matched:e.every(o=>T(o,r,n)),selections:i}},getSelectionKeys:()=>ie(e,M),matcherType:"and"})})}function pt(...e){return _({[C]:()=>({match:r=>{let i={};const n=(o,t)=>{i[o]=t;};return ie(e,M).forEach(o=>n(o,void 0)),{matched:e.some(o=>T(o,r,n)),selections:i}},getSelectionKeys:()=>ie(e,M),matcherType:"or"})})}function I(e){return {[C]:()=>({match:r=>({matched:!!e(r)})})}}function oe(...e){const r=typeof e[0]=="string"?e[0]:void 0,i=e.length===2?e[1]:typeof e[0]=="string"?void 0:e[0];return _({[C]:()=>({match:n=>{let o={[r??de]:n};return {matched:i===void 0||T(i,n,(t,s)=>{o[t]=s;}),selections:o}},getSelectionKeys:()=>[r??de].concat(i===void 0?[]:M(i))})})}function mt(e){return  true}function P(e){return typeof e=="number"}function E(e){return typeof e=="string"}function j(e){return typeof e=="bigint"}const yt=_(I(mt)),Ct=_(I(mt)),Ft=yt,A=e=>Object.assign(_(e),{startsWith:r=>{return A(x(e,(i=r,I(n=>E(n)&&n.startsWith(i)))));var i;},endsWith:r=>{return A(x(e,(i=r,I(n=>E(n)&&n.endsWith(i)))));var i;},minLength:r=>A(x(e,(i=>I(n=>E(n)&&n.length>=i))(r))),length:r=>A(x(e,(i=>I(n=>E(n)&&n.length===i))(r))),maxLength:r=>A(x(e,(i=>I(n=>E(n)&&n.length<=i))(r))),includes:r=>{return A(x(e,(i=r,I(n=>E(n)&&n.includes(i)))));var i;},regex:r=>{return A(x(e,(i=r,I(n=>E(n)&&!!n.match(i)))));var i;}}),Ae=A(I(E)),N=e=>Object.assign(_(e),{between:(r,i)=>N(x(e,((n,o)=>I(t=>P(t)&&n<=t&&o>=t))(r,i))),lt:r=>N(x(e,(i=>I(n=>P(n)&&n<i))(r))),gt:r=>N(x(e,(i=>I(n=>P(n)&&n>i))(r))),lte:r=>N(x(e,(i=>I(n=>P(n)&&n<=i))(r))),gte:r=>N(x(e,(i=>I(n=>P(n)&&n>=i))(r))),int:()=>N(x(e,I(r=>P(r)&&Number.isInteger(r)))),finite:()=>N(x(e,I(r=>P(r)&&Number.isFinite(r)))),positive:()=>N(x(e,I(r=>P(r)&&r>0))),negative:()=>N(x(e,I(r=>P(r)&&r<0)))}),Ot=N(I(P)),q=e=>Object.assign(_(e),{between:(r,i)=>q(x(e,((n,o)=>I(t=>j(t)&&n<=t&&o>=t))(r,i))),lt:r=>q(x(e,(i=>I(n=>j(n)&&n<i))(r))),gt:r=>q(x(e,(i=>I(n=>j(n)&&n>i))(r))),lte:r=>q(x(e,(i=>I(n=>j(n)&&n<=i))(r))),gte:r=>q(x(e,(i=>I(n=>j(n)&&n>=i))(r))),positive:()=>q(x(e,I(r=>j(r)&&r>0))),negative:()=>q(x(e,I(r=>j(r)&&r<0)))}),Pt=q(I(j)),Nt=_(I(function(e){return typeof e=="boolean"})),Bt=_(I(function(e){return typeof e=="symbol"})),Et=_(I(function(e){return e==null})),jt=_(I(function(e){return e!=null}));var G={__proto__:null,matcher:C,optional:Be,array:function(...e){return Ue({[C]:()=>({match:r=>{if(!Array.isArray(r))return {matched:false};if(e.length===0)return {matched:true};const i=e[0];let n={};if(r.length===0)return M(i).forEach(t=>{n[t]=[];}),{matched:true,selections:n};const o=(t,s)=>{n[t]=(n[t]||[]).concat([s]);};return {matched:r.every(t=>T(i,t,o)),selections:n}},getSelectionKeys:()=>e.length===0?[]:M(e[0])})})},set:function(...e){return _({[C]:()=>({match:r=>{if(!(r instanceof Set))return {matched:false};let i={};if(r.size===0)return {matched:true,selections:i};if(e.length===0)return {matched:true};const n=(t,s)=>{i[t]=(i[t]||[]).concat([s]);},o=e[0];return {matched:St(r,t=>T(o,t,n)),selections:i}},getSelectionKeys:()=>e.length===0?[]:M(e[0])})})},map:function(...e){return _({[C]:()=>({match:r=>{if(!(r instanceof Map))return {matched:false};let i={};if(r.size===0)return {matched:true,selections:i};const n=(c,u)=>{i[c]=(i[c]||[]).concat([u]);};if(e.length===0)return {matched:true};var o;if(e.length===1)throw new Error(`\`P.map\` wasn't given enough arguments. Expected (key, value), received ${(o=e[0])==null?void 0:o.toString()}`);const[t,s]=e;return {matched:Ut(r,(c,u)=>{const l=T(t,u,n),a=T(s,c,n);return l&&a}),selections:i}},getSelectionKeys:()=>e.length===0?[]:[...M(e[0]),...M(e[1])]})})},record:function(...e){return _({[C]:()=>({match:r=>{if(r===null||typeof r!="object"||Array.isArray(r))return {matched:false};var i;if(e.length===0)throw new Error(`\`P.record\` wasn't given enough arguments. Expected (value) or (key, value), received ${(i=e[0])==null?void 0:i.toString()}`);let n={};const o=(c,u)=>{n[c]=(n[c]||[]).concat([u]);},[t,s]=e.length===1?[Ae,e[0]]:e;return {matched:Mt(r,(c,u)=>{const l=typeof c!="string"||Number.isNaN(Number(c))?null:Number(c),a=l!==null&&T(t,l,o),h=T(t,c,o),f=T(s,u,o);return (h||a)&&f}),selections:n}},getSelectionKeys:()=>e.length===0?[]:[...M(e[0]),...M(e[1])]})})},intersection:x,union:pt,not:function(e){return _({[C]:()=>({match:r=>({matched:!T(e,r,()=>{})}),getSelectionKeys:()=>[],matcherType:"not"})})},when:I,select:oe,any:yt,unknown:Ct,_:Ft,string:Ae,number:Ot,bigint:Pt,boolean:Nt,symbol:Bt,nullish:Et,nonNullable:jt,instanceOf:function(e){return _(I((function(r){return i=>i instanceof r})(e)))},shape:function(e){return _(I(_t(e)))}};class At extends Error{constructor(r){let i;try{i=JSON.stringify(r);}catch{i=r;}super(`Pattern matching error: no pattern matches value ${i}`),this.input=void 0,this.input=r;}}const Me={matched:false,value:void 0};function qt(e){return new pe(e,Me)}class pe{constructor(r,i){this.input=void 0,this.state=void 0,this.input=r,this.state=i;}with(...r){if(this.state.matched)return this;const i=r[r.length-1],n=[r[0]];let o;r.length===3&&typeof r[1]=="function"?o=r[1]:r.length>2&&n.push(...r.slice(1,r.length-1));let t=false,s={};const c=(l,a)=>{t=true,s[l]=a;},u=!n.some(l=>T(l,this.input,c))||o&&!o(this.input)?Me:{matched:true,value:i(t?de in s?s[de]:s:this.input,this.input)};return new pe(this.input,u)}when(r,i){if(this.state.matched)return this;const n=!!r(this.input);return new pe(this.input,n?{matched:true,value:i(this.input,this.input)}:Me)}otherwise(r){return this.state.matched?this.state.value:r(this.input)}exhaustive(r=Dt){return this.state.matched?this.state.value:r(this.input)}run(){return this.exhaustive()}returnType(){return this}narrow(){return this}}function Dt(e){throw new At(e)}const F={fatal:0,error:0,warn:1,log:2,info:3,success:3,fail:3,debug:4,trace:5,verbose:Number.POSITIVE_INFINITY},qe={silent:{level:-1},fatal:{level:F.fatal},error:{level:F.error},warn:{level:F.warn},log:{level:F.log},info:{level:F.info},success:{level:F.success},fail:{level:F.fail},ready:{level:F.info},start:{level:F.info},box:{level:F.info},debug:{level:F.debug},trace:{level:F.trace},verbose:{level:F.verbose}};function me(e){if(e===null||typeof e!="object")return  false;const r=Object.getPrototypeOf(e);return r!==null&&r!==Object.prototype&&Object.getPrototypeOf(r)!==null||Symbol.iterator in e?false:Symbol.toStringTag in e?Object.prototype.toString.call(e)==="[object Module]":true}function Ce(e,r,i=".",n){if(!me(r))return Ce(e,{},i);const o=Object.assign({},r);for(const t in e){if(t==="__proto__"||t==="constructor")continue;const s=e[t];s!=null&&(Array.isArray(s)&&Array.isArray(o[t])?o[t]=[...s,...o[t]]:me(s)&&me(o[t])?o[t]=Ce(s,o[t],(i?`${i}.`:"")+t.toString()):o[t]=s);}return o}function Lt(e){return (...r)=>r.reduce((i,n)=>Ce(i,n,""),{})}const Vt=Lt();function Rt(e){return Object.prototype.toString.call(e)==="[object Object]"}function $t(e){return !(!Rt(e)||!e.message&&!e.args||e.stack)}let ye=false;const De=[];class S{options;_lastLog;_mockFn;constructor(r={}){const i=r.types||qe;this.options=Vt({...r,defaults:{...r.defaults},level:ge(r.level,i),reporters:[...r.reporters||[]]},{types:qe,throttle:1e3,throttleMin:5,formatOptions:{date:true,colors:false,compact:true}});for(const n in i){const o={type:n,...this.options.defaults,...i[n]};this[n]=this._wrapLogFn(o),this[n].raw=this._wrapLogFn(o,true);}this.options.mockFn&&this.mockTypes(),this._lastLog={};}get level(){return this.options.level}set level(r){this.options.level=ge(r,this.options.types,this.options.level);}prompt(r,i){if(!this.options.prompt)throw new Error("prompt is not supported!");return this.options.prompt(r,i)}create(r){const i=new S({...this.options,...r});return this._mockFn&&i.mockTypes(this._mockFn),i}withDefaults(r){return this.create({...this.options,defaults:{...this.options.defaults,...r}})}withTag(r){return this.withDefaults({tag:this.options.defaults.tag?this.options.defaults.tag+":"+r:r})}addReporter(r){return this.options.reporters.push(r),this}removeReporter(r){if(r){const i=this.options.reporters.indexOf(r);if(i!==-1)return this.options.reporters.splice(i,1)}else this.options.reporters.splice(0);return this}setReporters(r){return this.options.reporters=Array.isArray(r)?r:[r],this}wrapAll(){this.wrapConsole(),this.wrapStd();}restoreAll(){this.restoreConsole(),this.restoreStd();}wrapConsole(){for(const r in this.options.types)console["__"+r]||(console["__"+r]=console[r]),console[r]=this[r].raw;}restoreConsole(){for(const r in this.options.types)console["__"+r]&&(console[r]=console["__"+r],delete console["__"+r]);}wrapStd(){this._wrapStream(this.options.stdout,"log"),this._wrapStream(this.options.stderr,"log");}_wrapStream(r,i){r&&(r.__write||(r.__write=r.write),r.write=n=>{this[i].raw(String(n).trim());});}restoreStd(){this._restoreStream(this.options.stdout),this._restoreStream(this.options.stderr);}_restoreStream(r){r&&r.__write&&(r.write=r.__write,delete r.__write);}pauseLogs(){ye=true;}resumeLogs(){ye=false;const r=De.splice(0);for(const i of r)i[0]._logFn(i[1],i[2]);}mockTypes(r){const i=r||this.options.mockFn;if(this._mockFn=i,typeof i=="function")for(const n in this.options.types)this[n]=i(n,this.options.types[n])||this[n],this[n].raw=this[n];}_wrapLogFn(r,i){return (...n)=>{if(ye){De.push([this,r,n,i]);return}return this._logFn(r,n,i)}}_logFn(r,i,n){if((r.level||0)>this.level)return  false;const o={date:new Date,args:[],...r,level:ge(r.level,this.options.types)};!n&&i.length===1&&$t(i[0])?Object.assign(o,i[0]):o.args=[...i],o.message&&(o.args.unshift(o.message),delete o.message),o.additional&&(Array.isArray(o.additional)||(o.additional=o.additional.split(`
`)),o.args.push(`
`+o.additional.join(`
`)),delete o.additional),o.type=typeof o.type=="string"?o.type.toLowerCase():"log",o.tag=typeof o.tag=="string"?o.tag:"";const t=(c=false)=>{const u=(this._lastLog.count||0)-this.options.throttleMin;if(this._lastLog.object&&u>0){const l=[...this._lastLog.object.args];u>1&&l.push(`(repeated ${u} times)`),this._log({...this._lastLog.object,args:l}),this._lastLog.count=1;}c&&(this._lastLog.object=o,this._log(o));};clearTimeout(this._lastLog.timeout);const s=this._lastLog.time&&o.date?o.date.getTime()-this._lastLog.time.getTime():0;if(this._lastLog.time=o.date,s<this.options.throttle)try{const c=JSON.stringify([o.type,o.tag,o.args]),u=this._lastLog.serialized===c;if(this._lastLog.serialized=c,u&&(this._lastLog.count=(this._lastLog.count||0)+1,this._lastLog.count>this.options.throttleMin)){this._lastLog.timeout=setTimeout(t,this.options.throttle);return}}catch{}t(true);}_log(r){for(const i of this.options.reporters)i.log(r,{options:this.options});}}function ge(e,r={},i=3){return e===void 0?i:typeof e=="number"?e:r[e]&&r[e].level!==void 0?r[e].level:i}S.prototype.add=S.prototype.addReporter;S.prototype.remove=S.prototype.removeReporter;S.prototype.clear=S.prototype.removeReporter;S.prototype.withScope=S.prototype.withTag;S.prototype.mock=S.prototype.mockTypes;S.prototype.pause=S.prototype.pauseLogs;S.prototype.resume=S.prototype.resumeLogs;function Jt(e={}){return new S(e)}class zt{options;defaultColor;levelColorMap;typeColorMap;constructor(r){this.options={...r},this.defaultColor="#7f8c8d",this.levelColorMap={0:"#c0392b",1:"#f39c12",3:"#00BCD4"},this.typeColorMap={success:"#2ecc71"};}_getLogFn(r){return r<1?console.__error||console.error:r===1?console.__warn||console.warn:console.__log||console.log}log(r){const i=this._getLogFn(r.level),n=r.type==="log"?"":r.type,o=r.tag||"",s=`
      background: ${this.typeColorMap[r.type]||this.levelColorMap[r.level]||this.defaultColor};
      border-radius: 0.5em;
      color: white;
      font-weight: bold;
      padding: 2px 0.5em;
    `,c=`%c${[o,n].filter(Boolean).join(":")}`;typeof r.args[0]=="string"?i(`${c}%c ${r.args[0]}`,s,"",...r.args.slice(1)):i(c,s,...r.args);}}function Ht(e={}){return Jt({reporters:e.reporters||[new zt({})],prompt(i,n={}){return n.type==="confirm"?Promise.resolve(confirm(i)):Promise.resolve(prompt(i))},...e})}const Kt=Ht(),Le="tcml",Wt=Kt.withTag("Tunecore MIDI Lyrics"),Gt=e=>Wt.withTag(e);function Qt(e,r=document){return Array.from(r.querySelectorAll(e))}function Yt(e,r=document){const i=Qt(e,r);if(i.length===0)throw new Error(`No elements found for selector: ${e}`);return i}function gt(e,r=document){return r.querySelector(e)}function J(e,r=document){const i=gt(e,r);if(!i)throw new Error(`No element found for selector: ${e}`);return i}function Xt(e){if(Object.prototype.hasOwnProperty.call(e,"__esModule"))return e;var r=e.default;if(typeof r=="function"){var i=function n(){var o=false;try{o=this instanceof n;}catch{}return o?Reflect.construct(r,arguments,this.constructor):r.apply(this,arguments)};i.prototype=r.prototype;}else i={};return Object.defineProperty(i,"__esModule",{value:true}),Object.keys(e).forEach(function(n){var o=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(i,n,o.get?o:{enumerable:true,get:function(){return e[n]}});}),i}var V={},ae={},be,Ve;function Zt(){if(Ve)return be;Ve=1;function e(o){var t=new n(o),s=t.readChunk();if(s.id!="MThd")throw "Bad MIDI file.  Expected 'MHdr', got: '"+s.id+"'";for(var c=r(s.data),u=[],l=0;!t.eof()&&l<c.numTracks;l++){var a=t.readChunk();if(a.id!="MTrk")throw "Bad MIDI file.  Expected 'MTrk', got: '"+a.id+"'";var h=i(a.data);u.push(h);}return {header:c,tracks:u}}function r(o){var t=new n(o),s=t.readUInt16(),c=t.readUInt16(),u={format:s,numTracks:c},l=t.readUInt16();return l&32768?(u.framesPerSecond=256-(l>>8),u.ticksPerFrame=l&255):u.ticksPerBeat=l,u}function i(o){for(var t=new n(o),s=[];!t.eof();){var c=l();s.push(c);}return s;var u;function l(){var a={};a.deltaTime=t.readVarInt();var h=t.readUInt8();if((h&240)===240)if(h===255){a.meta=true;var f=t.readUInt8(),d=t.readVarInt();switch(f){case 0:if(a.type="sequenceNumber",d!==2)throw "Expected length for sequenceNumber event is 2, got "+d;return a.number=t.readUInt16(),a;case 1:return a.type="text",a.text=t.readString(d),a;case 2:return a.type="copyrightNotice",a.text=t.readString(d),a;case 3:return a.type="trackName",a.text=t.readString(d),a;case 4:return a.type="instrumentName",a.text=t.readString(d),a;case 5:return a.type="lyrics",a.text=t.readString(d),a;case 6:return a.type="marker",a.text=t.readString(d),a;case 7:return a.type="cuePoint",a.text=t.readString(d),a;case 32:if(a.type="channelPrefix",d!=1)throw "Expected length for channelPrefix event is 1, got "+d;return a.channel=t.readUInt8(),a;case 33:if(a.type="portPrefix",d!=1)throw "Expected length for portPrefix event is 1, got "+d;return a.port=t.readUInt8(),a;case 47:if(a.type="endOfTrack",d!=0)throw "Expected length for endOfTrack event is 0, got "+d;return a;case 81:if(a.type="setTempo",d!=3)throw "Expected length for setTempo event is 3, got "+d;return a.microsecondsPerBeat=t.readUInt24(),a;case 84:if(a.type="smpteOffset",d!=5)throw "Expected length for smpteOffset event is 5, got "+d;var b=t.readUInt8(),k={0:24,32:25,64:29,96:30};return a.frameRate=k[b&96],a.hour=b&31,a.min=t.readUInt8(),a.sec=t.readUInt8(),a.frame=t.readUInt8(),a.subFrame=t.readUInt8(),a;case 88:if(a.type="timeSignature",d!=2&&d!=4)throw "Expected length for timeSignature event is 4 or 2, got "+d;return a.numerator=t.readUInt8(),a.denominator=1<<t.readUInt8(),d===4?(a.metronome=t.readUInt8(),a.thirtyseconds=t.readUInt8()):(a.metronome=36,a.thirtyseconds=8),a;case 89:if(a.type="keySignature",d!=2)throw "Expected length for keySignature event is 2, got "+d;return a.key=t.readInt8(),a.scale=t.readUInt8(),a;case 127:return a.type="sequencerSpecific",a.data=t.readBytes(d),a;default:return a.type="unknownMeta",a.data=t.readBytes(d),a.metatypeByte=f,a}}else if(h==240){a.type="sysEx";var d=t.readVarInt();return a.data=t.readBytes(d),a}else if(h==247){a.type="endSysEx";var d=t.readVarInt();return a.data=t.readBytes(d),a}else throw "Unrecognised MIDI event type byte: "+h;else {var y;if((h&128)===0){if(u===null)throw "Running status byte encountered before status byte";y=h,h=u,a.running=true;}else y=t.readUInt8(),u=h;var m=h>>4;switch(a.channel=h&15,m){case 8:return a.type="noteOff",a.noteNumber=y,a.velocity=t.readUInt8(),a;case 9:var g=t.readUInt8();return a.type=g===0?"noteOff":"noteOn",a.noteNumber=y,a.velocity=g,g===0&&(a.byte9=true),a;case 10:return a.type="noteAftertouch",a.noteNumber=y,a.amount=t.readUInt8(),a;case 11:return a.type="controller",a.controllerType=y,a.value=t.readUInt8(),a;case 12:return a.type="programChange",a.programNumber=y,a;case 13:return a.type="channelAftertouch",a.amount=y,a;case 14:return a.type="pitchBend",a.value=y+(t.readUInt8()<<7)-8192,a;default:throw "Unrecognised MIDI event type: "+m}}}}function n(o){this.buffer=o,this.bufferLen=this.buffer.length,this.pos=0;}return n.prototype.eof=function(){return this.pos>=this.bufferLen},n.prototype.readUInt8=function(){var o=this.buffer[this.pos];return this.pos+=1,o},n.prototype.readInt8=function(){var o=this.readUInt8();return o&128?o-256:o},n.prototype.readUInt16=function(){var o=this.readUInt8(),t=this.readUInt8();return (o<<8)+t},n.prototype.readInt16=function(){var o=this.readUInt16();return o&32768?o-65536:o},n.prototype.readUInt24=function(){var o=this.readUInt8(),t=this.readUInt8(),s=this.readUInt8();return (o<<16)+(t<<8)+s},n.prototype.readInt24=function(){var o=this.readUInt24();return o&8388608?o-16777216:o},n.prototype.readUInt32=function(){var o=this.readUInt8(),t=this.readUInt8(),s=this.readUInt8(),c=this.readUInt8();return (o<<24)+(t<<16)+(s<<8)+c},n.prototype.readBytes=function(o){var t=this.buffer.slice(this.pos,this.pos+o);return this.pos+=o,t},n.prototype.readString=function(o){var t=this.readBytes(o);return String.fromCharCode.apply(null,t)},n.prototype.readVarInt=function(){for(var o=0;!this.eof();){var t=this.readUInt8();if(t&128)o+=t&127,o<<=7;else return o+t}return o},n.prototype.readChunk=function(){var o=this.readString(4),t=this.readUInt32(),s=this.readBytes(t);return {id:o,length:t,data:s}},be=e,be}var ve,Re;function er(){if(Re)return ve;Re=1;function e(t,s){if(typeof t!="object")throw "Invalid MIDI data";s=s||{};var c=t.header||{},u=t.tracks||[],l,a=u.length,h=new o;for(r(h,c,a),l=0;l<a;l++)i(h,u[l],s);return h.buffer}function r(t,s,c){var u=s.format==null?1:s.format,l=128;s.timeDivision?l=s.timeDivision:s.ticksPerFrame&&s.framesPerSecond?l=-(s.framesPerSecond&255)<<8|s.ticksPerFrame&255:s.ticksPerBeat&&(l=s.ticksPerBeat&32767);var a=new o;a.writeUInt16(u),a.writeUInt16(c),a.writeUInt16(l),t.writeChunk("MThd",a.buffer);}function i(t,s,c){var u=new o,l,a=s.length,h=null;for(l=0;l<a;l++)(c.running===false||!c.running&&!s[l].running)&&(h=null),h=n(u,s[l],h,c.useByte9ForNoteOff);t.writeChunk("MTrk",u.buffer);}function n(t,s,c,u){var l=s.type,a=s.deltaTime,h=s.text||"",f=s.data||[],d=null;switch(t.writeVarInt(a),l){case "sequenceNumber":t.writeUInt8(255),t.writeUInt8(0),t.writeVarInt(2),t.writeUInt16(s.number);break;case "text":t.writeUInt8(255),t.writeUInt8(1),t.writeVarInt(h.length),t.writeString(h);break;case "copyrightNotice":t.writeUInt8(255),t.writeUInt8(2),t.writeVarInt(h.length),t.writeString(h);break;case "trackName":t.writeUInt8(255),t.writeUInt8(3),t.writeVarInt(h.length),t.writeString(h);break;case "instrumentName":t.writeUInt8(255),t.writeUInt8(4),t.writeVarInt(h.length),t.writeString(h);break;case "lyrics":t.writeUInt8(255),t.writeUInt8(5),t.writeVarInt(h.length),t.writeString(h);break;case "marker":t.writeUInt8(255),t.writeUInt8(6),t.writeVarInt(h.length),t.writeString(h);break;case "cuePoint":t.writeUInt8(255),t.writeUInt8(7),t.writeVarInt(h.length),t.writeString(h);break;case "channelPrefix":t.writeUInt8(255),t.writeUInt8(32),t.writeVarInt(1),t.writeUInt8(s.channel);break;case "portPrefix":t.writeUInt8(255),t.writeUInt8(33),t.writeVarInt(1),t.writeUInt8(s.port);break;case "endOfTrack":t.writeUInt8(255),t.writeUInt8(47),t.writeVarInt(0);break;case "setTempo":t.writeUInt8(255),t.writeUInt8(81),t.writeVarInt(3),t.writeUInt24(s.microsecondsPerBeat);break;case "smpteOffset":t.writeUInt8(255),t.writeUInt8(84),t.writeVarInt(5);var b={24:0,25:32,29:64,30:96},k=s.hour&31|b[s.frameRate];t.writeUInt8(k),t.writeUInt8(s.min),t.writeUInt8(s.sec),t.writeUInt8(s.frame),t.writeUInt8(s.subFrame);break;case "timeSignature":t.writeUInt8(255),t.writeUInt8(88),t.writeVarInt(4),t.writeUInt8(s.numerator);var y=Math.floor(Math.log(s.denominator)/Math.LN2)&255;t.writeUInt8(y),t.writeUInt8(s.metronome),t.writeUInt8(s.thirtyseconds||8);break;case "keySignature":t.writeUInt8(255),t.writeUInt8(89),t.writeVarInt(2),t.writeInt8(s.key),t.writeUInt8(s.scale);break;case "sequencerSpecific":t.writeUInt8(255),t.writeUInt8(127),t.writeVarInt(f.length),t.writeBytes(f);break;case "unknownMeta":s.metatypeByte!=null&&(t.writeUInt8(255),t.writeUInt8(s.metatypeByte),t.writeVarInt(f.length),t.writeBytes(f));break;case "sysEx":t.writeUInt8(240),t.writeVarInt(f.length),t.writeBytes(f);break;case "endSysEx":t.writeUInt8(247),t.writeVarInt(f.length),t.writeBytes(f);break;case "noteOff":var m=u!==false&&s.byte9||u&&s.velocity==0?144:128;d=m|s.channel,d!==c&&t.writeUInt8(d),t.writeUInt8(s.noteNumber),t.writeUInt8(s.velocity);break;case "noteOn":d=144|s.channel,d!==c&&t.writeUInt8(d),t.writeUInt8(s.noteNumber),t.writeUInt8(s.velocity);break;case "noteAftertouch":d=160|s.channel,d!==c&&t.writeUInt8(d),t.writeUInt8(s.noteNumber),t.writeUInt8(s.amount);break;case "controller":d=176|s.channel,d!==c&&t.writeUInt8(d),t.writeUInt8(s.controllerType),t.writeUInt8(s.value);break;case "programChange":d=192|s.channel,d!==c&&t.writeUInt8(d),t.writeUInt8(s.programNumber);break;case "channelAftertouch":d=208|s.channel,d!==c&&t.writeUInt8(d),t.writeUInt8(s.amount);break;case "pitchBend":d=224|s.channel,d!==c&&t.writeUInt8(d);var g=8192+s.value,v=g&127,p=g>>7&127;t.writeUInt8(v),t.writeUInt8(p);break;default:throw "Unrecognized event type: "+l}return d}function o(){this.buffer=[];}return o.prototype.writeUInt8=function(t){this.buffer.push(t&255);},o.prototype.writeInt8=o.prototype.writeUInt8,o.prototype.writeUInt16=function(t){var s=t>>8&255,c=t&255;this.writeUInt8(s),this.writeUInt8(c);},o.prototype.writeInt16=o.prototype.writeUInt16,o.prototype.writeUInt24=function(t){var s=t>>16&255,c=t>>8&255,u=t&255;this.writeUInt8(s),this.writeUInt8(c),this.writeUInt8(u);},o.prototype.writeInt24=o.prototype.writeUInt24,o.prototype.writeUInt32=function(t){var s=t>>24&255,c=t>>16&255,u=t>>8&255,l=t&255;this.writeUInt8(s),this.writeUInt8(c),this.writeUInt8(u),this.writeUInt8(l);},o.prototype.writeInt32=o.prototype.writeUInt32,o.prototype.writeBytes=function(t){this.buffer=this.buffer.concat(Array.prototype.slice.call(t,0));},o.prototype.writeString=function(t){var s,c=t.length,u=[];for(s=0;s<c;s++)u.push(t.codePointAt(s));this.writeBytes(u);},o.prototype.writeVarInt=function(t){if(t<0)throw "Cannot write negative variable-length integer";if(t<=127)this.writeUInt8(t);else {var s=t,c=[];for(c.push(s&127),s>>=7;s;){var u=s&127|128;c.push(u),s>>=7;}this.writeBytes(c.reverse());}},o.prototype.writeChunk=function(t,s){this.writeString(t),this.writeUInt32(s.length),this.writeBytes(s);},ve=e,ve}var $e;function Ee(){return $e||($e=1,ae.parseMidi=Zt(),ae.writeMidi=er()),ae}var ke={},R={},Je;function bt(){if(Je)return R;Je=1,Object.defineProperty(R,"__esModule",{value:true}),R.insert=R.search=void 0;function e(i,n,o){o===void 0&&(o="ticks");var t=0,s=i.length,c=s;if(s>0&&i[s-1][o]<=n)return s-1;for(;t<c;){var u=Math.floor(t+(c-t)/2),l=i[u],a=i[u+1];if(l[o]===n){for(var h=u;h<i.length;h++){var f=i[h];f[o]===n&&(u=h);}return u}else {if(l[o]<n&&a[o]>n)return u;l[o]>n?c=u:l[o]<n&&(t=u+1);}}return  -1}R.search=e;function r(i,n,o){if(o===void 0&&(o="ticks"),i.length){var t=e(i,n[o],o);i.splice(t+1,0,n);}else i.push(n);}return R.insert=r,R}var ze;function Fe(){return ze||(ze=1,(function(e){Object.defineProperty(e,"__esModule",{value:true}),e.Header=e.keySignatureKeys=void 0;var r=bt(),i=new WeakMap;e.keySignatureKeys=["Cb","Gb","Db","Ab","Eb","Bb","F","C","G","D","A","E","B","F#","C#"];var n=(function(){function o(t){var s=this;if(this.tempos=[],this.timeSignatures=[],this.keySignatures=[],this.meta=[],this.name="",i.set(this,480),t){i.set(this,t.header.ticksPerBeat),t.tracks.forEach(function(u){u.forEach(function(l){l.meta&&(l.type==="timeSignature"?s.timeSignatures.push({ticks:l.absoluteTime,timeSignature:[l.numerator,l.denominator]}):l.type==="setTempo"?s.tempos.push({bpm:6e7/l.microsecondsPerBeat,ticks:l.absoluteTime}):l.type==="keySignature"&&s.keySignatures.push({key:e.keySignatureKeys[l.key+7],scale:l.scale===0?"major":"minor",ticks:l.absoluteTime}));});});var c=0;t.tracks[0].forEach(function(u){c+=u.deltaTime,u.meta&&(u.type==="trackName"?s.name=u.text:(u.type==="text"||u.type==="cuePoint"||u.type==="marker"||u.type==="lyrics")&&s.meta.push({text:u.text,ticks:c,type:u.type}));}),this.update();}}return o.prototype.update=function(){var t=this,s=0,c=0;this.tempos.sort(function(u,l){return u.ticks-l.ticks}),this.tempos.forEach(function(u,l){var a=l>0?t.tempos[l-1].bpm:t.tempos[0].bpm,h=u.ticks/t.ppq-c,f=60/a*h;u.time=f+s,s=u.time,c+=h;}),this.timeSignatures.sort(function(u,l){return u.ticks-l.ticks}),this.timeSignatures.forEach(function(u,l){var a=l>0?t.timeSignatures[l-1]:t.timeSignatures[0],h=(u.ticks-a.ticks)/t.ppq,f=h/a.timeSignature[0]/(a.timeSignature[1]/4);a.measures=a.measures||0,u.measures=f+a.measures;});},o.prototype.ticksToSeconds=function(t){var s=(0, r.search)(this.tempos,t);if(s!==-1){var c=this.tempos[s],u=c.time,l=(t-c.ticks)/this.ppq;return u+60/c.bpm*l}else {var a=t/this.ppq;return 60/120*a}},o.prototype.ticksToMeasures=function(t){var s=(0, r.search)(this.timeSignatures,t);if(s!==-1){var c=this.timeSignatures[s],u=(t-c.ticks)/this.ppq;return c.measures+u/(c.timeSignature[0]/c.timeSignature[1])/4}else return t/this.ppq/4},Object.defineProperty(o.prototype,"ppq",{get:function(){return i.get(this)},enumerable:false,configurable:true}),o.prototype.secondsToTicks=function(t){var s=(0, r.search)(this.tempos,t,"time");if(s!==-1){var c=this.tempos[s],u=c.time,l=t-u,a=l/(60/c.bpm);return Math.round(c.ticks+a*this.ppq)}else {var h=t/.5;return Math.round(h*this.ppq)}},o.prototype.toJSON=function(){return {keySignatures:this.keySignatures,meta:this.meta,name:this.name,ppq:this.ppq,tempos:this.tempos.map(function(t){return {bpm:t.bpm,ticks:t.ticks}}),timeSignatures:this.timeSignatures}},o.prototype.fromJSON=function(t){this.name=t.name,this.tempos=t.tempos.map(function(s){return Object.assign({},s)}),this.timeSignatures=t.timeSignatures.map(function(s){return Object.assign({},s)}),this.keySignatures=t.keySignatures.map(function(s){return Object.assign({},s)}),this.meta=t.meta.map(function(s){return Object.assign({},s)}),i.set(this,t.ppq),this.update();},o.prototype.setTempo=function(t){this.tempos=[{bpm:t,ticks:0}],this.update();},o})();e.Header=n;})(ke)),ke}var Q={},Ie={},He;function vt(){return He||(He=1,(function(e){Object.defineProperty(e,"__esModule",{value:true}),e.ControlChange=e.controlChangeIds=e.controlChangeNames=void 0,e.controlChangeNames={1:"modulationWheel",2:"breath",4:"footController",5:"portamentoTime",7:"volume",8:"balance",10:"pan",64:"sustain",65:"portamentoTime",66:"sostenuto",67:"softPedal",68:"legatoFootswitch",84:"portamentoControl"},e.controlChangeIds=Object.keys(e.controlChangeNames).reduce(function(o,t){return o[e.controlChangeNames[t]]=t,o},{});var r=new WeakMap,i=new WeakMap,n=(function(){function o(t,s){r.set(this,s),i.set(this,t.controllerType),this.ticks=t.absoluteTime,this.value=t.value;}return Object.defineProperty(o.prototype,"number",{get:function(){return i.get(this)},enumerable:false,configurable:true}),Object.defineProperty(o.prototype,"name",{get:function(){return e.controlChangeNames[this.number]?e.controlChangeNames[this.number]:null},enumerable:false,configurable:true}),Object.defineProperty(o.prototype,"time",{get:function(){var t=r.get(this);return t.ticksToSeconds(this.ticks)},set:function(t){var s=r.get(this);this.ticks=s.secondsToTicks(t);},enumerable:false,configurable:true}),o.prototype.toJSON=function(){return {number:this.number,ticks:this.ticks,time:this.time,value:this.value}},o})();e.ControlChange=n;})(Ie)),Ie}var Y={},Ke;function tr(){if(Ke)return Y;Ke=1,Object.defineProperty(Y,"__esModule",{value:true}),Y.createControlChanges=void 0;var e=vt();function r(){return new Proxy({},{get:function(i,n){if(i[n])return i[n];if(e.controlChangeIds.hasOwnProperty(n))return i[e.controlChangeIds[n]]},set:function(i,n,o){return e.controlChangeIds.hasOwnProperty(n)?i[e.controlChangeIds[n]]=o:i[n]=o,true}})}return Y.createControlChanges=r,Y}var X={},We;function rr(){if(We)return X;We=1,Object.defineProperty(X,"__esModule",{value:true}),X.PitchBend=void 0;var e=new WeakMap,r=(function(){function i(n,o){e.set(this,o),this.ticks=n.absoluteTime,this.value=n.value;}return Object.defineProperty(i.prototype,"time",{get:function(){var n=e.get(this);return n.ticksToSeconds(this.ticks)},set:function(n){var o=e.get(this);this.ticks=o.secondsToTicks(n);},enumerable:false,configurable:true}),i.prototype.toJSON=function(){return {ticks:this.ticks,time:this.time,value:this.value}},i})();return X.PitchBend=r,X}var Z={},B={},Ge;function nr(){return Ge||(Ge=1,Object.defineProperty(B,"__esModule",{value:true}),B.DrumKitByPatchID=B.InstrumentFamilyByID=B.instrumentByPatchID=void 0,B.instrumentByPatchID=["acoustic grand piano","bright acoustic piano","electric grand piano","honky-tonk piano","electric piano 1","electric piano 2","harpsichord","clavi","celesta","glockenspiel","music box","vibraphone","marimba","xylophone","tubular bells","dulcimer","drawbar organ","percussive organ","rock organ","church organ","reed organ","accordion","harmonica","tango accordion","acoustic guitar (nylon)","acoustic guitar (steel)","electric guitar (jazz)","electric guitar (clean)","electric guitar (muted)","overdriven guitar","distortion guitar","guitar harmonics","acoustic bass","electric bass (finger)","electric bass (pick)","fretless bass","slap bass 1","slap bass 2","synth bass 1","synth bass 2","violin","viola","cello","contrabass","tremolo strings","pizzicato strings","orchestral harp","timpani","string ensemble 1","string ensemble 2","synthstrings 1","synthstrings 2","choir aahs","voice oohs","synth voice","orchestra hit","trumpet","trombone","tuba","muted trumpet","french horn","brass section","synthbrass 1","synthbrass 2","soprano sax","alto sax","tenor sax","baritone sax","oboe","english horn","bassoon","clarinet","piccolo","flute","recorder","pan flute","blown bottle","shakuhachi","whistle","ocarina","lead 1 (square)","lead 2 (sawtooth)","lead 3 (calliope)","lead 4 (chiff)","lead 5 (charang)","lead 6 (voice)","lead 7 (fifths)","lead 8 (bass + lead)","pad 1 (new age)","pad 2 (warm)","pad 3 (polysynth)","pad 4 (choir)","pad 5 (bowed)","pad 6 (metallic)","pad 7 (halo)","pad 8 (sweep)","fx 1 (rain)","fx 2 (soundtrack)","fx 3 (crystal)","fx 4 (atmosphere)","fx 5 (brightness)","fx 6 (goblins)","fx 7 (echoes)","fx 8 (sci-fi)","sitar","banjo","shamisen","koto","kalimba","bag pipe","fiddle","shanai","tinkle bell","agogo","steel drums","woodblock","taiko drum","melodic tom","synth drum","reverse cymbal","guitar fret noise","breath noise","seashore","bird tweet","telephone ring","helicopter","applause","gunshot"],B.InstrumentFamilyByID=["piano","chromatic percussion","organ","guitar","bass","strings","ensemble","brass","reed","pipe","synth lead","synth pad","synth effects","world","percussive","sound effects"],B.DrumKitByPatchID={0:"standard kit",8:"room kit",16:"power kit",24:"electronic kit",25:"tr-808 kit",32:"jazz kit",40:"brush kit",48:"orchestra kit",56:"sound fx kit"}),B}var Qe;function ir(){if(Qe)return Z;Qe=1,Object.defineProperty(Z,"__esModule",{value:true}),Z.Instrument=void 0;var e=nr(),r=new WeakMap,i=(function(){function n(o,t){if(this.number=0,r.set(this,t),this.number=0,o){var s=o.find(function(c){return c.type==="programChange"});s&&(this.number=s.programNumber);}}return Object.defineProperty(n.prototype,"name",{get:function(){return this.percussion?e.DrumKitByPatchID[this.number]:e.instrumentByPatchID[this.number]},set:function(o){var t=e.instrumentByPatchID.indexOf(o);t!==-1&&(this.number=t);},enumerable:false,configurable:true}),Object.defineProperty(n.prototype,"family",{get:function(){return this.percussion?"drums":e.InstrumentFamilyByID[Math.floor(this.number/8)]},enumerable:false,configurable:true}),Object.defineProperty(n.prototype,"percussion",{get:function(){var o=r.get(this);return o.channel===9},enumerable:false,configurable:true}),n.prototype.toJSON=function(){return {family:this.family,number:this.number,name:this.name}},n.prototype.fromJSON=function(o){this.number=o.number;},n})();return Z.Instrument=i,Z}var ee={},Ye;function or(){if(Ye)return ee;Ye=1,Object.defineProperty(ee,"__esModule",{value:true}),ee.Note=void 0;function e(s){var c=Math.floor(s/12)-1;return r(s)+c.toString()}function r(s){var c=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],u=s%12;return c[u]}function i(s){var c=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];return c.indexOf(s)}var n=(function(){var s=/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i,c={cbb:-2,cb:-1,c:0,"c#":1,cx:2,dbb:0,db:1,d:2,"d#":3,dx:4,ebb:2,eb:3,e:4,"e#":5,ex:6,fbb:3,fb:4,f:5,"f#":6,fx:7,gbb:5,gb:6,g:7,"g#":8,gx:9,abb:7,ab:8,a:9,"a#":10,ax:11,bbb:9,bb:10,b:11,"b#":12,bx:13};return function(u){var l=s.exec(u),a=l[1],h=l[2],f=c[a.toLowerCase()];return f+(parseInt(h,10)+1)*12}})(),o=new WeakMap,t=(function(){function s(c,u,l){o.set(this,l),this.midi=c.midi,this.velocity=c.velocity,this.noteOffVelocity=u.velocity,this.ticks=c.ticks,this.durationTicks=u.ticks-c.ticks;}return Object.defineProperty(s.prototype,"name",{get:function(){return e(this.midi)},set:function(c){this.midi=n(c);},enumerable:false,configurable:true}),Object.defineProperty(s.prototype,"octave",{get:function(){return Math.floor(this.midi/12)-1},set:function(c){var u=c-this.octave;this.midi+=u*12;},enumerable:false,configurable:true}),Object.defineProperty(s.prototype,"pitch",{get:function(){return r(this.midi)},set:function(c){this.midi=12*(this.octave+1)+i(c);},enumerable:false,configurable:true}),Object.defineProperty(s.prototype,"duration",{get:function(){var c=o.get(this);return c.ticksToSeconds(this.ticks+this.durationTicks)-c.ticksToSeconds(this.ticks)},set:function(c){var u=o.get(this),l=u.secondsToTicks(this.time+c);this.durationTicks=l-this.ticks;},enumerable:false,configurable:true}),Object.defineProperty(s.prototype,"time",{get:function(){var c=o.get(this);return c.ticksToSeconds(this.ticks)},set:function(c){var u=o.get(this);this.ticks=u.secondsToTicks(c);},enumerable:false,configurable:true}),Object.defineProperty(s.prototype,"bars",{get:function(){var c=o.get(this);return c.ticksToMeasures(this.ticks)},enumerable:false,configurable:true}),s.prototype.toJSON=function(){return {duration:this.duration,durationTicks:this.durationTicks,midi:this.midi,name:this.name,ticks:this.ticks,time:this.time,velocity:this.velocity}},s})();return ee.Note=t,ee}var Xe;function Ze(){if(Xe)return Q;Xe=1,Object.defineProperty(Q,"__esModule",{value:true}),Q.Track=void 0;var e=bt(),r=vt(),i=tr(),n=rr(),o=ir(),t=or(),s=new WeakMap,c=(function(){function u(l,a){var h=this;if(this.name="",this.notes=[],this.controlChanges=(0, i.createControlChanges)(),this.pitchBends=[],s.set(this,a),l){var f=l.find(function(p){return p.type==="trackName"});this.name=f?f.text:"";}if(this.instrument=new o.Instrument(l,this),this.channel=0,l){for(var d=l.filter(function(p){return p.type==="noteOn"}),b=l.filter(function(p){return p.type==="noteOff"}),k=function(){var p=d.shift();y.channel=p.channel;var w=b.findIndex(function(H){return H.noteNumber===p.noteNumber&&H.absoluteTime>=p.absoluteTime});if(w!==-1){var U=b.splice(w,1)[0];y.addNote({durationTicks:U.absoluteTime-p.absoluteTime,midi:p.noteNumber,noteOffVelocity:U.velocity/127,ticks:p.absoluteTime,velocity:p.velocity/127});}},y=this;d.length;)k();var m=l.filter(function(p){return p.type==="controller"});m.forEach(function(p){h.addCC({number:p.controllerType,ticks:p.absoluteTime,value:p.value/127});});var g=l.filter(function(p){return p.type==="pitchBend"});g.forEach(function(p){h.addPitchBend({ticks:p.absoluteTime,value:p.value/Math.pow(2,13)});});var v=l.find(function(p){return p.type==="endOfTrack"});this.endOfTrackTicks=v!==void 0?v.absoluteTime:void 0;}}return u.prototype.addNote=function(l){var a=s.get(this),h=new t.Note({midi:0,ticks:0,velocity:1},{ticks:0,velocity:0},a);return Object.assign(h,l),(0, e.insert)(this.notes,h,"ticks"),this},u.prototype.addCC=function(l){var a=s.get(this),h=new r.ControlChange({controllerType:l.number},a);return delete l.number,Object.assign(h,l),Array.isArray(this.controlChanges[h.number])||(this.controlChanges[h.number]=[]),(0, e.insert)(this.controlChanges[h.number],h,"ticks"),this},u.prototype.addPitchBend=function(l){var a=s.get(this),h=new n.PitchBend({},a);return Object.assign(h,l),(0, e.insert)(this.pitchBends,h,"ticks"),this},Object.defineProperty(u.prototype,"duration",{get:function(){if(!this.notes.length)return 0;for(var l=this.notes[this.notes.length-1].time+this.notes[this.notes.length-1].duration,a=0;a<this.notes.length-1;a++){var h=this.notes[a].time+this.notes[a].duration;l<h&&(l=h);}return l},enumerable:false,configurable:true}),Object.defineProperty(u.prototype,"durationTicks",{get:function(){if(!this.notes.length)return 0;for(var l=this.notes[this.notes.length-1].ticks+this.notes[this.notes.length-1].durationTicks,a=0;a<this.notes.length-1;a++){var h=this.notes[a].ticks+this.notes[a].durationTicks;l<h&&(l=h);}return l},enumerable:false,configurable:true}),u.prototype.fromJSON=function(l){var a=this;this.name=l.name,this.channel=l.channel,this.instrument=new o.Instrument(void 0,this),this.instrument.fromJSON(l.instrument),l.endOfTrackTicks!==void 0&&(this.endOfTrackTicks=l.endOfTrackTicks);for(var h in l.controlChanges)l.controlChanges[h]&&l.controlChanges[h].forEach(function(f){a.addCC({number:f.number,ticks:f.ticks,value:f.value});});l.notes.forEach(function(f){a.addNote({durationTicks:f.durationTicks,midi:f.midi,ticks:f.ticks,velocity:f.velocity});});},u.prototype.toJSON=function(){for(var l={},a=0;a<127;a++)this.controlChanges.hasOwnProperty(a)&&(l[a]=this.controlChanges[a].map(function(f){return f.toJSON()}));var h={channel:this.channel,controlChanges:l,pitchBends:this.pitchBends.map(function(f){return f.toJSON()}),instrument:this.instrument.toJSON(),name:this.name,notes:this.notes.map(function(f){return f.toJSON()})};return this.endOfTrackTicks!==void 0&&(h.endOfTrackTicks=this.endOfTrackTicks),h},u})();return Q.Track=c,Q}var $={};function sr(e){var r=[];return kt(e,r),r}function kt(e,r){for(var i=0;i<e.length;i++){var n=e[i];Array.isArray(n)?kt(n,r):r.push(n);}}const ar=Object.freeze(Object.defineProperty({__proto__:null,flatten:sr},Symbol.toStringTag,{value:"Module"})),cr=Xt(ar);var et;function ur(){if(et)return $;et=1;var e=$&&$.__spreadArray||function(m,g,v){if(v||arguments.length===2)for(var p=0,w=g.length,U;p<w;p++)(U||!(p in g))&&(U||(U=Array.prototype.slice.call(g,0,p)),U[p]=g[p]);return m.concat(U||Array.prototype.slice.call(g))};Object.defineProperty($,"__esModule",{value:true}),$.encode=void 0;var r=Ee(),i=Fe(),n=cr;function o(m,g){return [{absoluteTime:m.ticks,channel:g,deltaTime:0,noteNumber:m.midi,type:"noteOn",velocity:Math.floor(m.velocity*127)},{absoluteTime:m.ticks+m.durationTicks,channel:g,deltaTime:0,noteNumber:m.midi,type:"noteOff",velocity:Math.floor(m.noteOffVelocity*127)}]}function t(m){return (0, n.flatten)(m.notes.map(function(g){return o(g,m.channel)}))}function s(m,g){return {absoluteTime:m.ticks,channel:g,controllerType:m.number,deltaTime:0,type:"controller",value:Math.floor(m.value*127)}}function c(m){for(var g=[],v=0;v<127;v++)m.controlChanges.hasOwnProperty(v)&&m.controlChanges[v].forEach(function(p){g.push(s(p,m.channel));});return g}function u(m,g){return {absoluteTime:m.ticks,channel:g,deltaTime:0,type:"pitchBend",value:m.value}}function l(m){var g=[];return m.pitchBends.forEach(function(v){g.push(u(v,m.channel));}),g}function a(m){return {absoluteTime:0,channel:m.channel,deltaTime:0,programNumber:m.instrument.number,type:"programChange"}}function h(m){return {absoluteTime:0,deltaTime:0,meta:true,text:m,type:"trackName"}}function f(m){return {absoluteTime:m.ticks,deltaTime:0,meta:true,microsecondsPerBeat:Math.floor(6e7/m.bpm),type:"setTempo"}}function d(m){return {absoluteTime:m.ticks,deltaTime:0,denominator:m.timeSignature[1],meta:true,metronome:24,numerator:m.timeSignature[0],thirtyseconds:8,type:"timeSignature"}}function b(m){var g=i.keySignatureKeys.indexOf(m.key);return {absoluteTime:m.ticks,deltaTime:0,key:g+7,meta:true,scale:m.scale==="major"?0:1,type:"keySignature"}}function k(m){return {absoluteTime:m.ticks,deltaTime:0,meta:true,text:m.text,type:m.type}}function y(m){var g={header:{format:1,numTracks:m.tracks.length+1,ticksPerBeat:m.header.ppq},tracks:e([e(e(e(e([{absoluteTime:0,deltaTime:0,meta:true,text:m.header.name,type:"trackName"}],m.header.keySignatures.map(function(v){return b(v)}),true),m.header.meta.map(function(v){return k(v)}),true),m.header.tempos.map(function(v){return f(v)}),true),m.header.timeSignatures.map(function(v){return d(v)}),true)],m.tracks.map(function(v){return e(e(e([h(v.name),a(v)],t(v),true),c(v),true),l(v),true)}),true)};return g.tracks=g.tracks.map(function(v){v=v.sort(function(w,U){return w.absoluteTime-U.absoluteTime});var p=0;return v.forEach(function(w){w.deltaTime=w.absoluteTime-p,p=w.absoluteTime,delete w.absoluteTime;}),v.push({deltaTime:0,meta:true,type:"endOfTrack"}),v}),new Uint8Array((0, r.writeMidi)(g))}return $.encode=y,$}var tt;function lr(){return tt||(tt=1,(function(e){var r=V&&V.__awaiter||function(h,f,d,b){function k(y){return y instanceof d?y:new d(function(m){m(y);})}return new(d||(d=Promise))(function(y,m){function g(w){try{p(b.next(w));}catch(U){m(U);}}function v(w){try{p(b.throw(w));}catch(U){m(U);}}function p(w){w.done?y(w.value):k(w.value).then(g,v);}p((b=b.apply(h,f||[])).next());})},i=V&&V.__generator||function(h,f){var d={label:0,sent:function(){if(y[0]&1)throw y[1];return y[1]},trys:[],ops:[]},b,k,y,m;return m={next:g(0),throw:g(1),return:g(2)},typeof Symbol=="function"&&(m[Symbol.iterator]=function(){return this}),m;function g(p){return function(w){return v([p,w])}}function v(p){if(b)throw new TypeError("Generator is already executing.");for(;d;)try{if(b=1,k&&(y=p[0]&2?k.return:p[0]?k.throw||((y=k.return)&&y.call(k),0):k.next)&&!(y=y.call(k,p[1])).done)return y;switch(k=0,y&&(p=[p[0]&2,y.value]),p[0]){case 0:case 1:y=p;break;case 4:return d.label++,{value:p[1],done:!1};case 5:d.label++,k=p[1],p=[0];continue;case 7:p=d.ops.pop(),d.trys.pop();continue;default:if(y=d.trys,!(y=y.length>0&&y[y.length-1])&&(p[0]===6||p[0]===2)){d=0;continue}if(p[0]===3&&(!y||p[1]>y[0]&&p[1]<y[3])){d.label=p[1];break}if(p[0]===6&&d.label<y[1]){d.label=y[1],y=p;break}if(y&&d.label<y[2]){d.label=y[2],d.ops.push(p);break}y[2]&&d.ops.pop(),d.trys.pop();continue}p=f.call(h,d);}catch(w){p=[6,w],k=0;}finally{b=y=0;}if(p[0]&5)throw p[1];return {value:p[0]?p[1]:void 0,done:true}}};Object.defineProperty(e,"__esModule",{value:true}),e.Header=e.Track=e.Midi=void 0;var n=Ee(),o=Fe(),t=Ze(),s=ur(),c=(function(){function h(f){var d=this,b=null;if(f){var k=f instanceof ArrayBuffer?new Uint8Array(f):f;b=(0, n.parseMidi)(k),b.tracks.forEach(function(y){var m=0;y.forEach(function(g){m+=g.deltaTime,g.absoluteTime=m;});}),b.tracks=a(b.tracks);}this.header=new o.Header(b),this.tracks=[],f&&(this.tracks=b.tracks.map(function(y){return new t.Track(y,d.header)}),b.header.format===1&&this.tracks[0].duration===0&&this.tracks.shift());}return h.fromUrl=function(f){return r(this,void 0,void 0,function(){var d,b;return i(this,function(k){switch(k.label){case 0:return [4,fetch(f)];case 1:return d=k.sent(),d.ok?[4,d.arrayBuffer()]:[3,3];case 2:return b=k.sent(),[2,new h(b)];case 3:throw new Error("Could not load '".concat(f,"'"))}})})},Object.defineProperty(h.prototype,"name",{get:function(){return this.header.name},set:function(f){this.header.name=f;},enumerable:false,configurable:true}),Object.defineProperty(h.prototype,"duration",{get:function(){var f=this.tracks.map(function(d){return d.duration});return Math.max.apply(Math,f)},enumerable:false,configurable:true}),Object.defineProperty(h.prototype,"durationTicks",{get:function(){var f=this.tracks.map(function(d){return d.durationTicks});return Math.max.apply(Math,f)},enumerable:false,configurable:true}),h.prototype.addTrack=function(){var f=new t.Track(void 0,this.header);return this.tracks.push(f),f},h.prototype.toArray=function(){return (0, s.encode)(this)},h.prototype.toJSON=function(){return {header:this.header.toJSON(),tracks:this.tracks.map(function(f){return f.toJSON()})}},h.prototype.fromJSON=function(f){var d=this;this.header=new o.Header,this.header.fromJSON(f.header),this.tracks=f.tracks.map(function(b){var k=new t.Track(void 0,d.header);return k.fromJSON(b),k});},h.prototype.clone=function(){var f=new h;return f.fromJSON(this.toJSON()),f},h})();e.Midi=c;var u=Ze();Object.defineProperty(e,"Track",{enumerable:true,get:function(){return u.Track}});var l=Fe();Object.defineProperty(e,"Header",{enumerable:true,get:function(){return l.Header}});function a(h){for(var f=[],d=0;d<h.length;d++)for(var b=f.length,k=new Map,y=Array(16).fill(0),m=0,g=h[d];m<g.length;m++){var v=g[m],p=b,w=v.channel;if(w!==void 0){v.type==="programChange"&&(y[w]=v.programNumber);var U=y[w],H="".concat(U," ").concat(w);k.has(H)?p=k.get(H):(p=b+k.size,k.set(H,p));}f[p]||f.push([]),f[p].push(v);}return f}})(V)),V}var fr=lr(),hr=Ee();const dr=1e-6,pr=Ne({try:e=>new fr.Midi(e),catch:e=>({type:"parseError",message:String(e)})}),mr=Ne({try:e=>hr.parseMidi(e),catch:e=>({type:"parseError",message:String(e)})}),yr=Ne({try:e=>new TextDecoder().decode(new Uint8Array(e.split("").map(r=>r.charCodeAt(0)))),catch:e=>({type:"invalidTextEncoding",message:String(e)})});function gr(e){const r=pr(e);if(ue(r))return D(r.error);const i=r.value,n=mr(e);if(ue(n))return D(n.error);const o=n.value,t=[],s=[];for(const f of o.tracks){let d=0;for(const b of f)if(d+=b.deltaTime,b.type==="text"){const k=yr(b.text);ue(k)?s.push(d):t.push({tick:d,text:k.value});}}if(s.length>0)return D({type:"invalidTextEncoding",positions:s.map(f=>ce(i.header,f))});const c=i.tracks.flatMap(f=>f.notes);c.sort((f,d)=>f.ticks-d.ticks);const u=[],l=new Set;for(let f=0;f<c.length-1;f++)c[f].ticks+c[f].durationTicks>c[f+1].ticks&&l.add(c[f+1].ticks);if(l.size>0)return D({type:"overlappingNotes",positions:Array.from(l).map(f=>ce(i.header,f))});const a=[],h=new Set(c.map(f=>f.ticks));for(const f of t){const d=c.find(b=>b.ticks===f.tick);d?(u.push({time:d.time,text:f.text,midi:d.midi}),u.push({time:d.time+d.duration,text:"",midi:d.midi}),h.delete(f.tick)):a.push(f.tick);}if(a.length>0)return D({type:"noNote",positions:a.map(f=>ce(i.header,f))});if(h.size>t.length)return D({type:"excessiveTextEvents",positions:Array.from(h).map(f=>ce(i.header,f))});u.sort((f,d)=>f.time!==d.time?f.time-d.time:f.text.length-d.text.length);for(let f=u.length-2;f>=0;f--)u[f].text===""&&u[f].time===u[f+1].time&&u[f].midi===u[f+1].midi&&u.splice(f,1);for(let f=0;f<u.length-1;f++)u[f].time<u[f+1].time||(u[f+1].time=u[f].time+dr);return u.splice(u.length-1,1),_e(u.map(f=>({time:f.time,text:f.text})))}function ce(e,r){if(r<0)throw new Error("Ticks cannot be negative");let i=0;const n=e.timeSignatures;for(let o=0;o<n.length;o++){const t={ticks:n[o].ticks,numerator:n[o].timeSignature[0],denominator:n[o].timeSignature[1]},s=n[o+1],c=e.ppq*4*t.numerator/t.denominator;for(let u=t.ticks;u<(s?s.ticks:1/0);u+=c){if(r<u+c){const l=r-u,a=Math.floor(l/e.ppq%t.numerator)+1,h=l%e.ppq;return {measure:i,beat:a,tick:h}}i++;}}throw new Error("Could not convert ticks to position")}const O=Gt("index"),{div:we,h5:br,p:rt,button:vr,a:xe,span:kr,input:Ir}=ht.tags,K=ht.state(0);function wr(){const e=gt(`#lyrics_line_sync:not([data-${Le}-injected="true"])`);if(!e)return;O.info("Injecting MIDI lyrics form");const r=J(".caution",e),i=we({class:"tcml-container"},br({class:"tcml-title",style:"font-size: 110%;margin-bottom: 5px"},"MIDIから読み込む",kr({style:"font-size: 80%; margin-left: 1rem; color: #8e8e8e"},xe({target:"_blank",href:"https://github.com/sevenc-nanashi/tunecore-midi-lyrics"},"Tunecore MIDI Lyrics")," by ",xe({target:"_blank",href:"https://www.tunecore.co.jp/artists/sevenc-nanashi",style:"color: #48b0d5"},"Nanashi."))),rt({style:"margin-bottom: 5px; font-size: 80%"},"MIDIの歌詞情報を読み込み、歌詞入力欄に反映します。"),we({style:"display: flex; align-items: center"},we({style:"display: flex; align-items: center"},rt({style:"font-size: 80%"},"開始時間（秒）："),Ir({type:"number",class:"form-control",value:()=>K.val,step:"any",style:"width: 5rem; margin-left: 5px; margin-right: 10px",onchange:o=>{const t=o.target,s=Number(t.value);K.val=isNaN(s)?0:s;}},[])),vr({class:"btn btn-default",type:"button",onclick:xr},"MIDIを開く"),xe({target:"_blank",href:"https://github.com/sevenc-nanashi/tunecore-midi-lyrics#midi-spec",style:"margin-left: 10px; font-size: 80%"},"MIDIファイルの仕様について"))),n=r.parentElement;if(!n)throw new Error("Caution element has no parent");n.insertBefore(i,r.nextElementSibling),e.dataset[Le+"Injected"]="true";}async function xr(){O.info("Loading MIDI file");const e=await Tr();if(!e){O.warn("No MIDI file selected");return}O.info("MIDI file loaded",e);const r=gr(e);if(ue(r)){O.error("Failed to parse MIDI file",r.error),alert(`MIDIを読み込めませんでした。
${qt(r.error).with({type:"parseError",message:G.string},({message:a})=>`MIDIファイルを解析できませんでした：${a}`).with({type:"invalidTextEncoding",positions:G.array()},({positions:a})=>`MIDIの歌詞を正しくデコードできませんでした。
位置：${a.map(h=>`${h.measure}.${h.beat}.${h.tick}`).join("、")}`).with({type:"noNote",positions:G.array()},({positions:a})=>`MIDIの歌詞に対応するノートが見つかりませんでした。
位置：${a.map(h=>`${h.measure}.${h.beat}.${h.tick}`).join("、")}`).with({type:"excessiveTextEvents",positions:G.array()},({positions:a})=>`MIDIの歌詞に対応していないノートが存在します。
位置：${a.map(h=>`${h.measure}.${h.beat}.${h.tick}`).join("、")}`).with({type:"overlappingNotes",positions:G.array()},({positions:a})=>`ノートが重なっています。
位置：${a.map(h=>`${h.measure}.${h.beat}.${h.tick}`).join("、")}`).exhaustive()}`);return}const i=r.value;if(i[0].time<K.val){O.warn(`Lyrics start time (${i[0].time}) is before offset (${K.val})`),alert(`MIDIの歌詞の開始時間（${i[0].time}秒）が、指定したオフセット時間（${K.val}秒）より前です。オフセット時間を見直してください。`);return}const n=1500;if(i.length>n){if(!confirm(`MIDIの歌詞数が多すぎます（${i.length}個）。先頭の${n}個のみを読み込みます。続行しますか？`)){O.info("User cancelled loading due to excessive lyrics");return}i.splice(n);}else O.info(`Parsed ${i.length} lyric events from MIDI`);O.info("Clearing existing lyrics");const o=Yt(".lyrics_row");for(const a of o){const h=J(".remove_row_button",a);J(".start-time",a).textContent.trim()!==""&&h.click();}const t=J("textarea.lyrics-text"),s=r.value.map(a=>a.text);t.value=s.join(`
`);const c=new Event("input",{bubbles:true});t.dispatchEvent(c),O.info("Lyrics loaded into textarea");const u=J(".operation-button-wrapper audio"),l=J(".audio_control_container .set-button");l.removeAttribute("disabled");for(const[a,h]of i.entries()){const f=h.time-K.val;u.currentTime=f,J(`.lyrics_row[data-row_num="${a+1}"]`).click(),l.click();}l.setAttribute("disabled","true");}async function Tr(){return new Promise(e=>{const r=document.createElement("input");r.type="file",r.accept=".mid,.midi",r.style.display="none",r.addEventListener("change",()=>{const i=r.files?.[0];if(!i){e(null);return}const n=new FileReader;n.onload=()=>{const o=n.result;o instanceof ArrayBuffer?e(new Uint8Array(o)):e(null);},n.readAsArrayBuffer(i);}),document.body.appendChild(r),r.click(),document.body.removeChild(r);})}async function _r(){O.info("Script started"),setInterval(()=>{wr();},1e3);}_r();

})();